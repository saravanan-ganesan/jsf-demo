name: Glue Schema Deployment

on:
  workflow_dispatch:
    inputs:
      region:
        description: "AWS region to deploy"
        required: true
        default: "us-west-2"
        type: string
      business-unit:
        description: "Business unit (if applicable)"
        required: false
        type: string

permissions:
  id-token: write
  contents: write
  checks: read
  security-events: read
  actions: write
  pull-requests: write
  packages: read

jobs:
  glue_schema_setup:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repo
        uses: actions/checkout@v3

      # Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2   # <-- Must match the region where your registry exists

      # Step 3: Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      # Step 4: Deploy Glue Schemas using Python
      - name: Deploy Glue Schemas
        run: |
          python << 'EOF'
          import boto3
          import os
          from botocore.exceptions import ClientError
          
          # AWS region must match the Glue registry region
          REGION = "ap-south-1"
          glue = boto3.client('glue', region_name=REGION)
          schema_registry = "d2cSchemaRegistry"
          schema_dir = "schema"
          
          # Step 0: Ensure registry exists
          try:
              glue.get_registry(RegistryId={'RegistryName': schema_registry})
              print(f"Registry '{schema_registry}' exists.")
          except ClientError as e:
              if e.response['Error']['Code'] == 'EntityNotFoundException':
                  print(f"Registry '{schema_registry}' does not exist → Creating it.")
                  glue.create_registry(RegistryName=schema_registry)
              else:
                  raise e
          
          # Step 1: Iterate through schemas
          for file_name in os.listdir(schema_dir):
              if not file_name.endswith(".json"):
                  continue
          
              schema_name = file_name.replace(".json", "")
              schema_file_path = os.path.join(schema_dir, file_name)
          
              with open(schema_file_path) as f:
                  schema_definition = f.read()
          
              try:
                  # Check if schema exists
                  glue.get_schema(SchemaId={'SchemaName': schema_name, 'RegistryName': schema_registry})
                  print(f"Schema exists → Updating schema {schema_name}")
                  glue.update_schema(
                      SchemaId={'SchemaName': schema_name, 'RegistryName': schema_registry},
                      SchemaDefinition=schema_definition
                  )
              except glue.exceptions.EntityNotFoundException:
                  print(f"Schema does not exist → Creating schema {schema_name}")
                  glue.create_schema(
                      RegistryId={'RegistryName': schema_registry},
                      SchemaName=schema_name,
                      DataFormat='JSON',
                      Compatibility='NONE',
                      SchemaDefinition=schema_definition
                  )
          
          print("Glue Schema Deployment Completed Successfully")
          EOF
